<head>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
   integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
   crossorigin=""/>
   <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
   integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
   crossorigin=""></script>
   <style>
       #activity-map {
           height: 600px;
       }

       .action {
           border: 1px solid #333;
           border-radius: 3px;
           background: transparent;
           padding: 1em;
           margin: 1em auto;
       }
   </style>
</head>
<body>
    <div id="activity-map"></div>

    <button id="play-button" class="action">Play Run</button>
    <button id="stop-button" class="action">Stop Run</button>

    <label for="gain">Gain</label>
    <input type="range" min="0" max="1" step="0.1" id="gain" />

    <label for="waveform">Waveform type</label>
    <select id="waveform">
        <option value="sine" selected>Sine</option>
        <option value="square">Square</option>
        <option value="triangle">Triangle</option>
        <option value="sawtooth">Sawtooth</option>
    </select>

    <script type="module">
        import stream from "/data/activities/5351605570/stream-high.json" assert { type: "json" };

        const altitude = stream.find((s) => s.type === "altitude");
        const latlng = stream.find((s) => s.type === "latlng");

        const notes = altitude.data;

        const btn = document.querySelector("#play-button");
        const stopBtn = document.querySelector("#stop-button");
        const gainRange = document.querySelector("#gain");
        const waveform = document.querySelector("#waveform");

        const output = new AudioContext();

        let oscillator = null;
        let amplifier = null;
        let playing = null;
        let isPlaying = false;
        let paused = false;
        let note = 0;

        let marker;

        const playNotes = () => {

            if (!paused && note < notes.length) {
                amplifier.gain.value = document.querySelector("#gain").value;
                oscillator.frequency.value = 440 + (notes[note] * 64); // hertz

                marker.setLatLng(latlng.data[note]);

                note = note + 1;
            } else {
                amplifier.gain.value = 0;
            }

            if (!paused) {
                playing = window.setTimeout(playNotes, 25);
            }
        };

        btn.addEventListener("click", () => {
            if (!oscillator) {
                // Creates a constant tone
                oscillator = output.createOscillator();
                oscillator.type = waveform.value;

                amplifier = output.createGain();
                amplifier.gain.value = document.querySelector("#gain").value;
                amplifier.connect(output.destination);

                oscillator.connect(amplifier);
                oscillator.start();
            }

            if (altitude) {
                paused = false;
                playNotes();
            }
        });

        stopBtn.addEventListener("click", () => {
            paused = true;
        });

        gainRange.addEventListener("change", (event) => {
            amplifier.gain.value = event.target.value;
        });

        waveform.addEventListener("change", (event) => {
            oscillator.type = event.target.value;
        });

        const activityMap = L.map("activity-map").setView([50.73, -2.02], 13);
        const icon = L.icon({
            iconUrl: "/images/me.png",
            iconSize: [48, 68],
        });

        L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoiaWh1bnRpbmd0b24iLCJhIjoiY2pmMmQ4Zm1jMWVsOTJ4b205bWhvZ29vdSJ9.rAuuP5HUDa1dxbEoHOYI6A', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
            maxZoom: 18,
            id: 'mapbox/streets-v11',
            tileSize: 512,
            zoomOffset: -1,
            accessToken: 'pk.eyJ1IjoiaWh1bnRpbmd0b24iLCJhIjoiY2pmMmQ4Zm1jMWVsOTJ4b205bWhvZ29vdSJ9.rAuuP5HUDa1dxbEoHOYI6A'
        }).addTo(activityMap);

        const route = L.polyline(latlng.data, {
            color: 'blue',
            weight: 2,
            opacity: .7,
            lineJoin: 'round',
        }).addTo(activityMap);

        marker = L.marker(latlng.data[0], { icon }).addTo(activityMap);

        activityMap.fitBounds(route.getBounds());
    </script>
</body>