<head>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
   integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
   crossorigin=""/>
   <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
   integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
   crossorigin=""></script>
   <style>
       #activity-map {
           height: 600px;
       }

       #play-button {
           border: 1px solid #333;
           border-radius: 3px;
           background: transparent;
           padding: 1em;
           margin: 1em auto;
       }
   </style>
</head>
<body>
    <div id="activity-map"></div>

    <button id="play-button">Play</button>

    <script type="module">
        import stream from "/data/activities/streams/5421816578.json" assert { type: "json" };
        // import { play } from "./scripts/sounds.js";

        const altitude = stream.find((s) => s.type === "altitude");
        const latlng = stream.find((s) => s.type === "latlng");

        const btn = document.querySelector("#play-button");

        const output = new AudioContext();

        let marker;

        const play = (notes) => {
            let playing = null;
            let note = 0;
            let instrument = output.createOscillator();
            let amplifier = output.createGain();

            const playNotes = () => {
                if (note < notes.length) {
                    instrument.frequency.value = 440 + (notes[note] * 64); // hertz
                    marker.setLatLng(latlng.data[note]);
                    note = note + 1;
                } else {
                    amplifier.gain.value = 0;
                }
                playing = window.setTimeout(playNotes, 25);
            };

            instrument.type = 'sine';
            instrument.start();
            instrument.connect(amplifier);

            amplifier.gain.value = 0.7;
            amplifier.connect(output.destination);

            playNotes();
        };

        btn.addEventListener("click", () => {
            if (altitude) {
                play(altitude.data);
            }
        });

        const activityMap = L.map("activity-map").setView([50.73, -2.02], 13);
        const icon = L.icon({
            iconUrl: "/images/me.png",
            iconSize: [48, 68],
        });

        L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoiaWh1bnRpbmd0b24iLCJhIjoiY2pmMmQ4Zm1jMWVsOTJ4b205bWhvZ29vdSJ9.rAuuP5HUDa1dxbEoHOYI6A', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
            maxZoom: 18,
            id: 'mapbox/streets-v11',
            tileSize: 512,
            zoomOffset: -1,
            accessToken: 'pk.eyJ1IjoiaWh1bnRpbmd0b24iLCJhIjoiY2pmMmQ4Zm1jMWVsOTJ4b205bWhvZ29vdSJ9.rAuuP5HUDa1dxbEoHOYI6A'
        }).addTo(activityMap);

        const route = L.polyline(latlng.data, {
            color: 'blue',
            weight: 2,
            opacity: .7,
            lineJoin: 'round',
        }).addTo(activityMap);

        marker = L.marker(latlng.data[0], { icon }).addTo(activityMap);

        activityMap.fitBounds(route.getBounds());
    </script>
</body>